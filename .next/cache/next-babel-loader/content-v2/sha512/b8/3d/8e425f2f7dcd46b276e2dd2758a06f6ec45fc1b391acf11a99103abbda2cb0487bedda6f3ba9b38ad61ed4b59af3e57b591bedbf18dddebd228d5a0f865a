{"ast":null,"code":"const stripe = require('stripe')('rk_test_51J305OC6YuwVjGqqJ6Sj41vN15r5vfTbCiHd1slfDzXLSgdyjLxofs7oqGCBrWRlVXxpfbpIxHd3hmhmTlbWwGNx00UU16Rwo4');\n\nimport { sha256 } from 'js-sha256';\n\nconst handler = async (req, res) => {\n  //todo: check stripe signing key\n  if (req.method === \"POST\") {\n    const event = req.body; // need to verifiy that event came from stripe \n    // https://stripe.com/docs/identity/handle-verification-outcomes\n    // Handle the event\n\n    switch (event.type) {\n      case 'identity.verification_session.verified':\n        {\n          // All the verification checks passed\n          const verificationSession = event.data.object;\n          console.log(\"\\u001b[1;32m [ID verified] \\u001b[0m\"); // await console.log(`identity.verification_session.verified`, verificationSession);\n\n          const verifiedOutputs = await stripe.identity.verificationSessions.retrieve(verificationSession.id, {\n            expand: ['verified_outputs', 'verified_outputs.dob' // 'last_verification_report.document.number',\n            ]\n          });\n          const hash = makeHashOfDetails(verifiedOutputs);\n          console.log(hash);\n          EthereumStuff(verificationSession.id, hash);\n          console.log(\"\\u001b[1;32m [ID verified] \\u001b[0m\");\n          break;\n        }\n\n      default:\n        // Unexpected event type\n        console.log(`❌ Unhandled event type ${event.type}.`);\n    } // Return a 200 response to acknowledge receipt of the event\n\n\n    res.send(); // res.status(200).json({ })\n  } else {\n    res.setHeader(\"Allow\", \"POST\");\n    res.status(405).end(\"Method Not Allowed\");\n  }\n};\n\nconst makeHashOfDetails = verifiedOutputs => {\n  const firstName = verifiedOutputs.verified_outputs.first_name.toString().toLowerCase();\n  const lastName = verifiedOutputs.verified_outputs.last_name.toString().toLowerCase();\n  const dayStr = verifiedOutputs.verified_outputs.dob.day.toString();\n  const monthStr = verifiedOutputs.verified_outputs.dob.month.toString();\n  const yearStr = verifiedOutputs.verified_outputs.dob.year.toString();\n  const combination = firstName + lastName + dayStr + monthStr + yearStr;\n  console.log(combination);\n  const hashCombination = sha256(combination);\n  return hashCombination;\n};\n\nconst Web3 = require('web3');\n\nconst Provider = require('truffle-hdwallet-provider');\n\nconst MyContract = require('../../ethereum/build/IdVerification.json');\n\nconst address = '0xCE7DF6060580e5333c0Ab27e9B67b5634A449d6A';\nconst privateKey = '7a5e5b16d286a451082ee017f08410fae2c0062e4c7faa45f5beafc64df90664'; // this is my private key\n\nconst infuraUrl = 'https://rinkeby.infura.io/v3/675a260276d44f54a06355ce65310ba6';\nimport mimc from '../../mimc.ts';\n\nconst seedrandom = require('seedrandom');\n\nimport searchDatabase from '../../mongo.js';\n\nconst EthereumStuff = async (id, hash) => {\n  console.log(\"\\u001b[1;32m [Ethereum] \\u001b[0m\"); // set up contract and signing key\n\n  const web3 = new Web3(infuraUrl);\n  const myContract = new web3.eth.Contract(JSON.parse(MyContract.interface), '0x65a1772fF0c8eC4780c0d591a3774259e7d40bC1');\n  web3.eth.accounts.wallet.add(privateKey); // set up info for transaction\n  // take session id and seed random num generator with it so [id].js will be able to get same num\n  // get random num\n  // get Mimc hash of this num (this is the value we will claim we know the pre image of)\n  // convert Mimc hash to hex and store this val in contract\n  // this hex value will be the last input of zkp\n\n  var seededHash = seedrandom(id);\n  const randSeededNum = seededHash() * 1000000000000000000;\n  console.log(\"\\u001b[1;32m [Ethereum] \\u001b[0m randSeededNum\", randSeededNum);\n  const mimcVal = mimc(randSeededNum);\n  console.log(\"\\u001b[1;32m [Ethereum] \\u001b[0m mimc val\", mimcVal.toString());\n  var hexVal = mimcVal.toString(16);\n  console.log(\"\\u001b[1;32m [Ethereum] \\u001b[0m hexVal \", hexVal.toString());\n  hexVal = `0x${hexVal}`; // turn it into right format for contract\n\n  console.log(\"\\u001b[1;32m [Ethereum] \\u001b[0m hexVal \", hexVal); // search Database\n\n  await searchDatabase(hash).catch(console.error); // set up transaction\n\n  const tx = myContract.methods.addNewHash(hexVal);\n  const gas = await tx.estimateGas({\n    from: address\n  });\n  const gasPrice = await web3.eth.getGasPrice();\n  const data = tx.encodeABI();\n  const nonce = await web3.eth.getTransactionCount(address);\n  const txData = {\n    from: address,\n    to: myContract.options.address,\n    data: data,\n    gas: gas,\n    gasPrice: gasPrice,\n    nonce: nonce,\n    chain: 'rinkeby',\n    hardfork: 'istanbul'\n  }; // send transaction\n\n  const receipt = await web3.eth.sendTransaction(txData); // console.log transaction hash to show it has gone through\n\n  console.log(`\\u001b[1;32m [Ethereum] \\u001b[0m Transaction hash: ${receipt.transactionHash}`);\n};\n\nexport default handler;","map":{"version":3,"sources":["/Users/neilhacker/Desktop/working_on/ostrom_id_copy_5/pages/api/stripe_hook.js"],"names":["stripe","require","sha256","handler","req","res","method","event","body","type","verificationSession","data","object","console","log","verifiedOutputs","identity","verificationSessions","retrieve","id","expand","hash","makeHashOfDetails","EthereumStuff","send","setHeader","status","end","firstName","verified_outputs","first_name","toString","toLowerCase","lastName","last_name","dayStr","dob","day","monthStr","month","yearStr","year","combination","hashCombination","Web3","Provider","MyContract","address","privateKey","infuraUrl","mimc","seedrandom","searchDatabase","web3","myContract","eth","Contract","JSON","parse","interface","accounts","wallet","add","seededHash","randSeededNum","mimcVal","hexVal","catch","error","tx","methods","addNewHash","gas","estimateGas","from","gasPrice","getGasPrice","encodeABI","nonce","getTransactionCount","txData","to","options","chain","hardfork","receipt","sendTransaction","transactionHash"],"mappings":"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","sourcesContent":["const stripe = require('stripe')('rk_test_51J305OC6YuwVjGqqJ6Sj41vN15r5vfTbCiHd1slfDzXLSgdyjLxofs7oqGCBrWRlVXxpfbpIxHd3hmhmTlbWwGNx00UU16Rwo4');\nimport { sha256 } from 'js-sha256';\n\nconst handler = async (req, res) => {\n    //todo: check stripe signing key\n    if (req.method === \"POST\") {\n        const event = req.body;\n\n        // need to verifiy that event came from stripe \n        // https://stripe.com/docs/identity/handle-verification-outcomes\n      \n        // Handle the event\n        switch (event.type) {\n          case 'identity.verification_session.verified': {\n              // All the verification checks passed\n              const verificationSession = event.data.object;\n              console.log( \"\\u001b[1;32m [ID verified] \\u001b[0m\" );\n\n              // await console.log(`identity.verification_session.verified`, verificationSession);\n\n              const verifiedOutputs = await stripe.identity.verificationSessions.retrieve(\n                verificationSession.id,\n                {\n                  expand: [\n                    'verified_outputs',\n                    'verified_outputs.dob',\n                    // 'last_verification_report.document.number',\n                  ],\n                }\n              );\n              \n              const hash = makeHashOfDetails(verifiedOutputs);\n              console.log(hash)\n                            \n              EthereumStuff(verificationSession.id, hash);\n              console.log( \"\\u001b[1;32m [ID verified] \\u001b[0m\" );\n              break;\n            }\n        \n          default:\n            // Unexpected event type\n            console.log(`❌ Unhandled event type ${event.type}.`);\n        }\n        // Return a 200 response to acknowledge receipt of the event\n        res.send();\n        // res.status(200).json({ })\n    } else {\n      res.setHeader(\"Allow\", \"POST\");\n      res.status(405).end(\"Method Not Allowed\");\n    }\n}\n\nconst makeHashOfDetails = (verifiedOutputs) => {\n  const firstName = verifiedOutputs.verified_outputs.first_name.toString().toLowerCase();\n  const lastName = verifiedOutputs.verified_outputs.last_name.toString().toLowerCase();\n  const dayStr = verifiedOutputs.verified_outputs.dob.day.toString();\n  const monthStr = verifiedOutputs.verified_outputs.dob.month.toString();\n  const yearStr = verifiedOutputs.verified_outputs.dob.year.toString();\n\n  const combination = firstName + lastName + dayStr + monthStr + yearStr;\n  console.log(combination)\n\n  const hashCombination = sha256(combination);\n  return hashCombination;\n\n} \n\nconst Web3 = require('web3');\nconst Provider = require('truffle-hdwallet-provider');\nconst MyContract = require('../../ethereum/build/IdVerification.json');\nconst address = '0xCE7DF6060580e5333c0Ab27e9B67b5634A449d6A';\nconst privateKey = '7a5e5b16d286a451082ee017f08410fae2c0062e4c7faa45f5beafc64df90664'; // this is my private key\nconst infuraUrl = 'https://rinkeby.infura.io/v3/675a260276d44f54a06355ce65310ba6'; \nimport mimc from '../../mimc.ts';\nconst seedrandom = require('seedrandom');\nimport searchDatabase from '../../mongo.js'\n\n\n\nconst EthereumStuff = async (id, hash) => {\n  console.log( \"\\u001b[1;32m [Ethereum] \\u001b[0m\" );\n\n\n  // set up contract and signing key\n  const web3 = new Web3(infuraUrl);\n  const myContract = new web3.eth.Contract(\n    JSON.parse(MyContract.interface),\n    '0x65a1772fF0c8eC4780c0d591a3774259e7d40bC1'\n  );\n  web3.eth.accounts.wallet.add(privateKey);\n\n  // set up info for transaction\n  // take session id and seed random num generator with it so [id].js will be able to get same num\n  // get random num\n  // get Mimc hash of this num (this is the value we will claim we know the pre image of)\n  // convert Mimc hash to hex and store this val in contract\n  // this hex value will be the last input of zkp\n\n  var seededHash = seedrandom(id);\n  const randSeededNum = seededHash() * 1000000000000000000;\n  console.log(\"\\u001b[1;32m [Ethereum] \\u001b[0m randSeededNum\", randSeededNum)\n\n  const mimcVal = mimc(randSeededNum)\n  console.log(\"\\u001b[1;32m [Ethereum] \\u001b[0m mimc val\", mimcVal.toString())\n\n  var hexVal = mimcVal.toString(16);\n  console.log(\"\\u001b[1;32m [Ethereum] \\u001b[0m hexVal \", hexVal.toString())\n  hexVal = `0x${hexVal}` // turn it into right format for contract\n  console.log(\"\\u001b[1;32m [Ethereum] \\u001b[0m hexVal \", hexVal)\n\n  // search Database\n  await searchDatabase(hash).catch(console.error);\n\n  // set up transaction\n  const tx = myContract.methods.addNewHash(hexVal);\n  const gas = await tx.estimateGas({from: address});\n  const gasPrice = await web3.eth.getGasPrice();\n  const data = tx.encodeABI();\n  const nonce = await web3.eth.getTransactionCount(address);\n  const txData = {\n    from: address,\n    to: myContract.options.address,\n    data: data,\n    gas: gas,\n    gasPrice: gasPrice,\n    nonce: nonce, \n    chain: 'rinkeby', \n    hardfork: 'istanbul'\n  };\n  \n  // send transaction\n  const receipt = await web3.eth.sendTransaction(txData);\n\n  // console.log transaction hash to show it has gone through\n  console.log(`\\u001b[1;32m [Ethereum] \\u001b[0m Transaction hash: ${receipt.transactionHash}`);\n}\n\n\nexport default handler;"]},"metadata":{},"sourceType":"module"}